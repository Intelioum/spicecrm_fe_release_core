/*
SpiceUI 2018.10.001

Copyright (c) 2016-present, aac services.k.s - All rights reserved.
Redistribution and use in source and binary forms, without modification, are permitted provided that the following conditions are met:
- Redistributions of source code must retain this copyright and license notice, this list of conditions and the following disclaimer.
- Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
- If used the SpiceCRM Logo needs to be displayed in the upper left corner of the screen in a minimum dimension of 31x31 pixels and be clearly visible, the icon needs to provide a link to http://www.spicecrm.io
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

*/

"use strict";var __decorate=this&&this.__decorate||function(e,t,s,n){var r,a=arguments.length,o=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,s):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,n);else for(var i=e.length-1;0<=i;i--)(r=e[i])&&(o=(a<3?r(o):3<a?r(t,s,o):r(t,s))||o);return 3<a&&o&&Object.defineProperty(t,s,o),o},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var common_1=require("@angular/common"),core_1=require("@angular/core"),forms_1=require("@angular/forms"),router_1=require("@angular/router"),rxjs_1=require("rxjs"),services_1=require("../../services/services"),services_2=require("../../services/services"),services_3=require("../../services/services"),services_4=require("../../services/services"),services_5=require("../../services/services"),services_6=require("../../services/services"),services_7=require("../../services/services"),services_8=require("../../services/services"),services_9=require("../../services/services"),services_10=require("../../services/services"),services_11=require("../../services/services"),services_12=require("../../services/services"),services_13=require("../../services/services"),services_14=require("../../services/services"),objectfields_1=require("../../objectfields/objectfields"),globalcomponents_1=require("../../globalcomponents/globalcomponents"),objectcomponents_1=require("../../objectcomponents/objectcomponents"),systemcomponents_1=require("../../systemcomponents/systemcomponents"),directives_1=require("../../directives/directives"),calendar=function(){function e(e,t,s,n,r){this.backend=e,this.session=t,this.broadcast=s,this.modelutilities=n,this.userPreferences=r,this.usersCalendars$=new core_1.EventEmitter,this.usersCalendars=[],this.calendarDate={},this.calendars={},this.currentStart=null,this.currentEnd=null,this.sheetHourHeight=80,this.multiEventHeight=25,this.weekstartday=0,this.weekDaysCount=7,this.startHour=0,this.endHour=23,this.todayColor="#eb7092",this.absenceColor="#727272",this.loggedByGoogle=!1,this.loadPreferences(),this.getOtherCalendars(),this.modelChangesSubscriber()}return Object.defineProperty(e.prototype,"owner",{get:function(){return this.session.authData.userId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"weekStartDay",{get:function(){return this.weekstartday},set:function(e){this.weekstartday=e},enumerable:!0,configurable:!0}),e.prototype.addUserCalendar=function(e,t){var s=this.usersCalendars;s.push({id:e,name:t,visible:!0,color:"#"+(4095*Math.random()<<0).toString(16).toLowerCase()=="fff"?"ddd":(4095*Math.random()<<0).toString(16)}),this.setUserCalendars(s.slice())},e.prototype.removeUserCalendar=function(t){var e=this.usersCalendars.filter(function(e){return e.id!=t});this.setUserCalendars(e)},e.prototype.setUserCalendars=function(e){e&&(this.usersCalendars=e,this.userPreferences.setPreference("Users",this.usersCalendars,!0,"Calendar"),this.usersCalendars$.emit(this.usersCalendars))},e.prototype.loadEvents=function(e,t,r){var a=this;if(void 0===r&&(r=this.owner),!this.currentStart||!this.currentEnd||this.currentStart>e||this.currentEnd<t||!this.calendars[r]){this.currentEnd=t,this.currentStart=e;var o=new rxjs_1.Subject,s={start:e.format("YYYY-MM-DD HH:mm:ss"),end:t.format("YYYY-MM-DD HH:mm:ss")};return this.backend.getRequest("calendar/"+r,s).subscribe(function(e){a.calendars[r]=[];for(var t=0,s=e;t<s.length;t++){var n=s[t];switch(n.data=a.modelutilities.backendModel2spice(n.module,n.data),n.type){case"event":case"absence":n.start=moment(n.start).tz(moment.tz.guess()).add(moment().utcOffset(),"m"),n.end=moment(n.end).tz(moment.tz.guess()).add(moment().utcOffset(),"m")}"absence"!=n.type?0<+n.end.diff(n.start,"days")&&(n.isMulti=!0):(n.isMulti=!0,n.color=a.absenceColor,n.data.summary_text=n.data.type),a.calendars[r].push(n)}o.next(a.calendars[r]),o.complete()}),o.asObservable()}for(var n=[],i=0,l=this.calendars[r];i<l.length;i++){var d=l[i];d.start<t&&d.end>e&&n.push(d)}return rxjs_1.of(n)},e.prototype.getEvents=function(e){return void 0===e&&(e=this.owner),this.calendars[e]?this.calendars[e]:[]},e.prototype.arrangeEvents=function(e){e.sort(function(e,t){return e.start<t.start?-1:e.start===t.start&&e.end>t.end?-1:1});for(var t={},s=0,n=e;s<n.length;s++){for(var r=n[s],a=[],o=0,i=e;o<i.length;o++){var l=i[o];r.id!==l.id&&l.start<r.end&&l.end>r.start&&a.push({id:l.id,start:l.start,end:l.end})}var d=0;if(0<a.length){for(var c=0,h=a;c<h.length;c++){for(var u=h[c],p=0,m=0,g=a;m<g.length;m++){var v=g[m];v.start<u.end&&v.end>u.start&&p++}d<p&&(d=p)}d++}t[r.id]={maxOverlay:d,elementsOverlaid:a}}for(var y=[],f=0,b=e;f<b.length;f++){r=b[f];for(var _=0,x=[],w=0,C=e;w<C.length;w++){l=C[w];if(-1!==y.indexOf(l.id)&&l.start<r.end&&l.end>r.start)for(-1===x.indexOf(t[l.id].displayIndex)&&x.push(t[l.id].displayIndex);-1!==x.indexOf(_);)_++}t[r.id].displayIndex=_,y.push(r.id)}for(var E in t)for(var D=0,M=t[E].elementsOverlaid;D<M.length;D++){var S=M[D];t[E].maxOverlay<t[S.id].maxOverlay&&(t[E].maxOverlay=t[S.id].maxOverlay)}for(var k=0,H=e;k<H.length;k++){(r=H[k]).displayIndex=t[r.id].displayIndex,r.maxOverlay=t[r.id].maxOverlay}return e},e.prototype.modelChangesSubscriber=function(){var s=this;this.broadcast.message$.subscribe(function(t){if("Meetings"==t.messagedata.module||"Calls"==t.messagedata.module)switch(t.messagetype){case"model.save":var e=t.messagedata.data.assigned_user_id;if(!s.calendars[e])return;s.calendars[e].some(function(e){if(e.id==t.messagedata.id)return e.data=t.messagedata.data,e.start=t.messagedata.data.date_start,e.end=t.messagedata.data.date_end,!0})}})},e.prototype.loadPreferences=function(){this.weekStartDay="Monday"==this.userPreferences.unchangedPreferences.global.week_day_start?1:this.weekStartDay,this.weekDaysCount=+this.userPreferences.unchangedPreferences.global.week_days_count||this.weekDaysCount,this.startHour=+this.userPreferences.unchangedPreferences.global.calendar_day_start_hour||this.startHour,this.endHour=+this.userPreferences.unchangedPreferences.global.calendar_day_end_hour||this.endHour,this.calendarDate=new moment},e.prototype.getOtherCalendars=function(){var t=this;this.userPreferences.loadPreferences("Calendar").subscribe(function(e){t.setUserCalendars(e.Users)}),this.session.authData.googleToken&&(this.loggedByGoogle=!0)},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[services_7.backend,services_8.session,services_5.broadcast,services_3.modelutilities,userpreferences])],e)}();exports.calendar=calendar;var userpreferences=function(){function e(e,t,s){this.backend=e,this.toast=t,this.l=s,this.preferences={global:{}},this.unchangedPreferences={global:{}},this.preferencesComplete=!0,this.defaults={currency:-99,datef:"d.m.Y",dec_sep:",",num_grp_sep:".",timef:"H:i",timezone:"Europe/Vienna",default_currency_significant_digits:2,default_locale_name_format:"l, f",week_day_start:0},this.formats={nameFormats:[],loaded:!1},this.toUse=this.preferences.global}return e.prototype.getPreferences=function(t){this.loadPreferences().subscribe(function(e){t.next("getPreferences")})},e.prototype.loadPreferences=function(t){var s=this;void 0===t&&(t="global");var n=new rxjs_1.Subject;return this.backend.getRequest("user/preferences/"+t).subscribe(function(e){s.preferences[t]=_.extendOwn(s.preferences[t],e),"global"===t?(s.unchangedPreferences.global=_.clone(e),s.completePreferencesWithDefaults()):s.unchangedPreferences[t]=_.clone(e),n.next(e)}),n.asObservable()},e.prototype.completePreferencesWithDefaults=function(){var s=this,n=!1;_.each(this.defaults,function(e,t){"string"==typeof s.preferences.global[t]?s.preferences.global[t]||(s.preferences.global[t]=e,n=!0):void 0!==s.preferences.global[t]&&null!==s.preferences.global[t]||(s.preferences.global[t]=e,n=!0)}),this.preferencesComplete=!n},e.prototype.getPreference=function(e,t){void 0===t&&(t="global");try{return this.preferences[t][e]}catch(e){return!1}},e.prototype.setPreference=function(t,s,e,n){var r=this;if(void 0===e&&(e=!0),void 0===n&&(n="global"),e){var a={};a[t]=s,this.backend.postRequest("user/preferences/"+n,{},a).subscribe(function(e){r.preferences[n]||(r.preferences[n]={}),r.preferences[n][t]=s,r.unchangedPreferences[n][t]=s,r.completePreferencesWithDefaults()})}else this.preferences[n][t]=s,this.completePreferencesWithDefaults()},e.prototype.setPreferences=function(e,r){var a=this;void 0===r&&(r="global");var o=new rxjs_1.Subject;return this.backend.postRequest("user/preferences/"+r,{},e).subscribe(function(e){for(var t=0,s=a.preferences[r];t<s.length;t++){var n=s[t];e.hasOwnProperty(n)?a.preferences[r]=e[n]:delete a.preferences[r][n]}a.unchangedPreferences[r]=e,a.completePreferencesWithDefaults(),o.next(!0)},function(e){o.error(e)}),o},e.prototype.getDateFormat=function(){if(this.toUse.datef){var e=this.toUse.datef;return this.jsDateFormat2momentDateFormat(e)}return"YYYY-MM-DD"},e.prototype.jsDateFormat2momentDateFormat=function(e){return e.replace("Y","YYYY").replace("m","MM").replace("d","DD")},e.prototype.getTimeFormat=function(){if(this.toUse.timef){var e=this.toUse.timef;return this.jsTimeFormat2momentTimeFormat(e)}return"hh:mm"},e.prototype.jsTimeFormat2momentTimeFormat=function(e){return e.replace("H","HH").replace("h","hh").replace("i","mm")},e.prototype.needFormats=function(){this.formats.loaded||this.loadFormats()},e.prototype.loadFormats=function(){var r=this,a=new rxjs_1.Subject;return this.formats.nameFormats.length=0,this.formats.loaded=!1,this.backend.getRequest("user/preferencesformats").subscribe(function(e){for(var t=0,s=e.nameFormats;t<s.length;t++){var n=s[t];r.formats.nameFormats.push({name:n,example:r.translateNameFormat(n)})}r.formats.loaded=!0,a.next(!0)}),a.asObservable()},e.prototype.translateNameFormat=function(e){for(var t="",s=0;s<e.length;s++)switch(e.charAt(s)){case"t":t+=this.l.getLabel("LBL_LOCALE_NAME_EXAMPLE_TITLE");break;case"f":t+=this.l.getLabel("LBL_LOCALE_NAME_EXAMPLE_FIRST");break;case"l":t+=this.l.getLabel("LBL_LOCALE_NAME_EXAMPLE_LAST");break;case"s":t+=this.l.getLabel("LBL_LOCALE_NAME_EXAMPLE_SALUTATION");break;default:t+=e.charAt(s)}return t},e.prototype.formatMoney=function(e,t,s,n,r){void 0===t&&(t=this.toUse.default_currency_significant_digits),void 0===s&&(s=3),void 0===n&&(n=this.toUse.num_grp_sep),void 0===r&&(r=this.toUse.dec_sep);var a="\\d(?=(\\d{"+s+"})+"+(0<t?"\\D":"$")+")";return e.toFixed(Math.max(0,~~t)).replace(".",r).replace(new RegExp(a,"g"),"$&"+n)},e.prototype.formatDate=function(e){return moment(e).format(this.getDateFormat())},e.prototype.formatDateTime=function(e){return moment(e).format(this.getDateFormat())+" "+moment(e).format("HH:mm:ss")},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[services_7.backend,services_11.toast,services_4.language])],e)}();exports.userpreferences=userpreferences;var Calendar=function(){function Calendar(e,t,s,n,r,a,o){var i=this;this.language=e,this.broadcast=t,this.navigation=s,this.fts=n,this.recent=r,this.elementRef=a,this.calendar=o,this.usersCalendars=[],this.googleCalendarVisible=!0,this.searchterm="",this.searchopen=!1,this.isLoading=!1,this.resultsList=[],this.timeout=void 0,this.recentUsers=[],this.showTypeSelector=!1,this.sheetType="Week",this.duration={Day:"d",Week:"w",Month:"M"},this.navigation.setActiveModule("Calendar"),this.calendarDate=new moment,this.getRecent(),this.calendar.usersCalendars$.subscribe(function(e){return i.usersCalendars=e})}return Object.defineProperty(Calendar.prototype,"owner",{get:function(){return this.calendar.owner},enumerable:!0,configurable:!0}),Object.defineProperty(Calendar.prototype,"searchOpen",{get:function(){return this.searchopen},set:function(e){(this.searchopen=e)&&this.getRecent()},enumerable:!0,configurable:!0}),Object.defineProperty(Calendar.prototype,"loggedByGoogle",{get:function(){return this.calendar.loggedByGoogle},enumerable:!0,configurable:!0}),Object.defineProperty(Calendar.prototype,"lookupMenuStyle",{get:function(){return{display:this.searchOpen?"block":"none",width:this.inputContainer.element.nativeElement.getBoundingClientRect().width+"px"}},enumerable:!0,configurable:!0}),Object.defineProperty(Calendar.prototype,"weekStartDay",{get:function(){return this.calendar.weekStartDay},enumerable:!0,configurable:!0}),Object.defineProperty(Calendar.prototype,"weekDaysCount",{get:function(){return this.calendar.weekDaysCount},enumerable:!0,configurable:!0}),Object.defineProperty(Calendar.prototype,"calendarDate",{get:function(){return this.calendar.calendarDate},set:function(e){this.calendar.calendarDate=e},enumerable:!0,configurable:!0}),Object.defineProperty(Calendar.prototype,"searchTerm",{get:function(){return this.searchterm},set:function(e){var t=this;clearTimeout(this.timeout),this.timeout=setTimeout(function(){return t.searchterm=e},500),""!=e&&(this.isLoading=!0,this.fts.searchByModules(this.searchterm,["Users"],5,"",{sortfield:"name"}).subscribe(function(e){t.filterResultsList(e.Users.hits.map(function(e){return e._source})),t.isLoading=!1},function(e){return t.isLoading=!1}))},enumerable:!0,configurable:!0}),Calendar.prototype.getRecent=function(){var t=this;this.recent.getModuleRecent("Users").subscribe(function(e){return t.filterRecent(e)})},Calendar.prototype.filterRecent=function(e){var t=this;this.recentUsers=e.filter(function(e){return e.item_id!=t.owner&&null==_.findWhere(t.calendar.usersCalendars,{id:e.item_id})})},Calendar.prototype.filterResultsList=function(e){var t=this;this.resultsList=e.filter(function(e){return e.id!=t.owner&&null==_.findWhere(t.calendar.usersCalendars,{id:e.id})})},Calendar.prototype.addUserCalendar=function(e,t){this.calendar.addUserCalendar(e,t),this.filterRecent(this.recentUsers),this.filterResultsList(this.resultsList)},Calendar.prototype.removeUserCalendar=function(e){this.calendar.removeUserCalendar(e)},Calendar.prototype.toggleVisibleGoogle=function(){this.googleCalendarVisible=!this.googleCalendarVisible},Calendar.prototype.toggleVisibleUsers=function(t){var s=this;this.calendar.usersCalendars.some(function(e){if(e.id==t)return e.visible=!e.visible,s.calendar.setUserCalendars(s.calendar.usersCalendars.slice()),!0})},Calendar.prototype.getContentStyle=function(){return{height:"calc(100vh - "+this.calendarcontent.element.nativeElement.offsetTop+"px)"}},Calendar.prototype.getCalendarHeader=function(){var e=new moment(this.calendarDate);switch(this.sheetType){case"Week":return"Week "+this.getCalendarWeek()+": "+this.getFirstDayOfWeek()+" - "+this.getLastDayOfWeek();case"Month":return e.format("MMMM YYYY");case"Day":return e.format("MMMM D, YYYY")}},Calendar.prototype.getCalendarWeek=function(){var e=new moment(this.calendarDate);return e.day(1),e.isoWeek()},Calendar.prototype.getFirstDayOfWeek=function(){var e=new moment(this.calendarDate);return e.day(this.weekStartDay),e.format("MMMM D, YYYY")},Calendar.prototype.getLastDayOfWeek=function(){var e=new moment(this.calendarDate);return e.day(this.weekDaysCount),e.format("MMMM D, YYYY")},Calendar.prototype.setDateChanged=function(e){this.calendarDate=new moment(e)},Calendar.prototype.toggleTypeSelector=function(){this.showTypeSelector=!this.showTypeSelector},Calendar.prototype.setType=function(e){this.sheetType=e,this.refresh(),this.showTypeSelector=!1},Calendar.prototype.goToday=function(){this.calendarDate=new moment},Calendar.prototype.gotToDayView=function(e){this.refresh(),this.calendarDate=e,this.sheetType="Day"},Calendar.prototype.goToWeekView=function(){this.sheetType="Week"},Calendar.prototype.shiftPlus=function(){var e=7-this.weekDaysCount;"Day"==this.sheetType&&this.calendarDate.day()==this.weekStartDay+(this.weekDaysCount-1)&&(this.calendarDate=new moment(this.calendarDate.add(moment.duration(e,"d")))),this.calendarDate=new moment(this.calendarDate.add(moment.duration(1,this.duration[this.sheetType])))},Calendar.prototype.shiftMinus=function(){var e=7-this.weekDaysCount;"Day"==this.sheetType&&this.calendarDate.day()==this.weekStartDay&&(this.calendarDate=new moment(this.calendarDate.subtract(moment.duration(e,"d")))),this.calendarDate=new moment(this.calendarDate.subtract(moment.duration(1,this.duration[this.sheetType])))},Calendar.prototype.zoomin=function(){this.calendar.sheetHourHeight+=10},Calendar.prototype.zoomout=function(){this.calendar.sheetHourHeight-=10},Calendar.prototype.resetzoom=function(){this.calendar.sheetHourHeight=80},Calendar.prototype.refresh=function(){this.calendar.currentStart=void 0,this.calendar.currentEnd=void 0,this.calendarDate=new moment(this.calendar.calendarDate)},__decorate([core_1.ViewChild("calendarcontent",{read:core_1.ViewContainerRef}),__metadata("design:type",core_1.ViewContainerRef)],Calendar.prototype,"calendarcontent",void 0),__decorate([core_1.ViewChild("inputcontainer",{read:core_1.ViewContainerRef}),__metadata("design:type",core_1.ViewContainerRef)],Calendar.prototype,"inputContainer",void 0),Calendar=__decorate([core_1.Component({template:'<div class="slds-theme--default"><div class="slds-page-header"><div class="slds-grid"><div class="slds-col slds-has-flexi-truncate"><div class="slds-media slds-no-space slds-grow"><object-icon [module]="\'Calendar\'"></object-icon><div class="slds-media__body"><p class="slds-text-title--caps slds-line-height--reset">{{language.getModuleName(\'Calendar\')}}</p><h1 class="slds-page-header__title slds-m-right--small slds-align-middle slds-truncate">{{getCalendarHeader()}}</h1></div></div></div><div class="slds-col slds-no-flex slds-grid slds-align-top"><div class="slds-button-group" role="group"><button class="slds-button slds-button--icon-border" (click)="shiftMinus()"><system-button-icon [icon]="\'chevronleft\'"></system-button-icon></button> <button class="slds-button slds-button--icon-border" (click)="shiftPlus()"><system-button-icon [icon]="\'chevronright\'"></system-button-icon></button></div><button class="slds-button slds-button--icon-border" (click)="refresh()"><system-button-icon [icon]="\'refresh\'"></system-button-icon></button> <button class="slds-button slds-button--neutral" (click)="goToday()">{{language.getLabel(\'LBL_TODAY\')}}</button><div class="slds-dropdown-trigger slds-dropdown-trigger--click slds-m-left--x-small" [ngClass]="{\'slds-is-open\': showTypeSelector}"><button class="slds-button slds-button--neutral" (click)="toggleTypeSelector()">{{sheetType}}<system-button-icon [icon]="\'down\'"></system-button-icon></button><div class="slds-dropdown slds-dropdown--right slds-dropdown--x-small"><ul class="slds-dropdown__list" role="menu"><li class="slds-dropdown__item" role="presentation"><a href="javascript:void(0);" role="menuitem" (click)="setType(\'Day\')"><span class="slds-truncate">{{language.getLabel(\'LBL_DAY\')}}</span></a></li><li class="slds-dropdown__item" role="presentation" (click)="setType(\'Week\')"><a href="javascript:void(0);" role="menuitem"><span class="slds-truncate">{{language.getLabel(\'LBL_WEEK\')}}</span></a></li><li class="slds-dropdown__item" role="presentation" (click)="setType(\'Month\')"><a href="javascript:void(0);" role="menuitem"><span class="slds-truncate">{{language.getLabel(\'LBL_MONTH\')}}</span></a></li></ul></div></div><div class="slds-button-group slds-m-left--x-small" role="group"><button class="slds-button slds-button--icon-border" (click)="zoomout()" [disabled]="calendar.sheetHourHeight <=50"><system-button-icon [icon]="\'zoomout\'"></system-button-icon></button> <button class="slds-button slds-button--icon-border" (click)="resetzoom()" [disabled]="calendar.sheetHourHeight ==80"><system-button-icon [icon]="\'undo\'"></system-button-icon></button> <button class="slds-button slds-button--icon-border" (click)="zoomin()" [disabled]="calendar.sheetHourHeight >=120"><system-button-icon [icon]="\'zoomin\'"></system-button-icon></button></div></div></div></div><div #calendarcontent class="slds-grid" [ngStyle]="getContentStyle()"><div style="width:300px" class="slds-border--right slds-p-top--xx-small slds-scrollable--y"><calendar-date-picker [setdate]="calendarDate" (setdateChange)="setDateChanged($event)"></calendar-date-picker><div class="slds-border--bottom"><label class="slds-form-element__label slds-text-heading--small slds-p-horizontal--small">{{language.getLabel(\'LBL_OTHER_CALENDARS\')}}</label><div class="slds-p-vertical--xx-small"><div *ngIf="loggedByGoogle" class="slds-form-element slds-grid slds-grid--align-spread slds-p-horizontal--small slds-p-vertical--xxx-small" (mouseover)="hovered = \'google\'" (mouseout)="hovered = \'\'" [ngClass]="hovered == \'google\' ? \'slds-theme--shade\' : \'\'"><div class="slds-grid" (click)="toggleVisibleGoogle()" style="cursor: pointer"><img src="https://developers.google.com/identity/images/g-logo.png" style="height: 13px;width:13px;margin-right: 2px; margin-top: 2px" [ngStyle]="!googleCalendarVisible ? {\'-webkit-filter\': \'grayscale(1)\',\'filter\': \'grayscale(1)\'} : {}"> <a class="slds-text-body--regular slds-truncate" [style.color]="!googleCalendarVisible ? \'#dddbda\' : \'initial\'">{{language.getLabel(\'MY_GOOGLE_CALENDAR\')}}</a></div></div><div *ngFor="let usersCalendar of usersCalendars" class="slds-form-element slds-grid slds-grid--align-spread slds-p-horizontal--small slds-p-vertical--xxx-small" (mouseover)="hovered = usersCalendar.id" (mouseout)="hovered = \'\'" [ngClass]="hovered == usersCalendar.id ? \'slds-theme--shade\' : \'\'"><div class="slds-grid" (click)="toggleVisibleUsers(usersCalendar.id)" style="cursor: pointer"><div class="slds-button slds-button--icon slds-m-right--xx-small slds-p-top--xxx-small" [style.color]="usersCalendar.visible ? usersCalendar.color : \'#dddbda\'"><system-button-icon icon="user" size="small"></system-button-icon></div><a class="slds-text-body--regular slds-truncate" [style.color]="usersCalendar.visible ? usersCalendar.color : \'#dddbda\'">{{usersCalendar.name}}</a></div><button class="slds-button slds-button--icon" (click)="removeUserCalendar(usersCalendar.id)"><system-button-icon icon="clear" size="small"></system-button-icon></button></div></div></div><div class="slds-form-element__control slds-p-around--x-small slds-border--bottom slds-theme--default" style="height: 52px"><div #inputcontainer class="slds-form-element slds-lookup"><div class="slds-form-element__control slds-grid slds-box--border slds-m-vertical--xxx-small"><div class="slds-input-has-icon slds-input-has-icon--right slds-grow"><system-utility-icon [icon]="\'search\'" [addclasses]="\'slds-input__icon\'"></system-utility-icon><input type="search" class="slds-lookup__search-input slds-input--bare" [(ngModel)]="searchTerm" (focus)="searchOpen = true" (blur)="searchOpen = false" [placeholder]="language.getLabel(\'LBL_ADD\') + \' \' + language.getLabel(\'LBL_USER\') + \' \' + language.getLabel(\'LBL_CALENDAR\')" role="combobox"></div></div></div><div *ngIf="searchOpen" class="slds-lookup__menu slds-size--1-of-4 slds-p-vertical--none" [ngStyle]="lookupMenuStyle"><div *ngIf="searchTerm.length > 0" class="slds-theme--shade slds-p-around--xx-small slds-text-body--small slds-text-title--caps slds-border--bottom">{{resultsList.length}} {{language.getLabel(\'LBL_USERS\')}} {{language.getLabel(\'LBL_FOUND\')}}</div><div *ngIf="searchTerm.length == 0" class="slds-theme--shade slds-p-around--xx-small slds-text-body--small slds-text-title--caps slds-border--bottom">{{language.getLabel(\'LBL_RECENTLYVIEWED\')}}</div><ul class="slds-lookup__list" style="height: 175px" role="listbox"><ng-container *ngIf="searchTerm.length > 0"><li *ngFor="let user of resultsList" role="presentation" (mousedown)="addUserCalendar(user.id, user.summary_text)"><div class="slds-lookup__item-action slds-media" role="option"><system-icon icon="user" size="x-small" divClass="slds-p-around--xxx-small slds-m-right--xxx-small"></system-icon><span class="slds-lookup__result-text">{{user.summary_text}}</span></div></li></ng-container><ng-container *ngIf="searchTerm.length == 0"><li *ngFor="let user of recentUsers" role="presentation" (mousedown)="addUserCalendar(user.item_id, user.item_summary)"><div class="slds-lookup__item-action slds-media" role="option"><system-icon icon="user" size="x-small" divClass="slds-p-around--xxx-small slds-m-right--xxx-small"></system-icon><span class="slds-lookup__result-text">{{user.item_summary}}</span></div></li></ng-container></ul><system-spinner [size]="16" *ngIf="isLoading && resultsList.length == 0"></system-spinner></div></div></div><div style="width:calc(100% - 300px); height: 100%"><calendar-sheet-day *ngIf="sheetType === \'Day\'" [googlecalendarvisible]="googleCalendarVisible" [userscalendars]="usersCalendars" [setdate]="calendarDate" (navigateweek)="goToWeekView()"></calendar-sheet-day><calendar-sheet-week *ngIf="sheetType === \'Week\'" [googlecalendarvisible]="googleCalendarVisible" [userscalendars]="usersCalendars" [setdate]="calendarDate" (navigateday)="gotToDayView($event)"></calendar-sheet-week><calendar-sheet-month *ngIf="sheetType === \'Month\'" [googlecalendarvisible]="googleCalendarVisible" [userscalendars]="usersCalendars" [setdate]="calendarDate" (navigateday)="gotToDayView($event)"></calendar-sheet-month></div></div></div>',providers:[calendar],styles:["\n        /* Scrollbar */\n        /* width */\n        ::-webkit-scrollbar {\n            width: 5px;\n        }\n\n        /* Track */\n        ::-webkit-scrollbar-track {\n            background: #f1f1f1;\n        }\n\n        /* Handle */\n        ::-webkit-scrollbar-thumb {\n            background: #aaa;\n        }\n\n        /* Handle on hover */\n        ::-webkit-scrollbar-thumb:hover {\n            background: #888;\n        }\n    "]}),__metadata("design:paramtypes",[services_4.language,services_5.broadcast,services_6.navigation,services_12.fts,services_13.recent,core_1.ElementRef,calendar])],Calendar)}();exports.Calendar=Calendar;var CalendarDatePicker=function(){function e(e,t){this.language=e,this.calendar=t,this.setdate=new moment,this.setdateChange=new core_1.EventEmitter,this.curDate=new moment,this.currentGrid=[]}return e.prototype.ngOnInit=function(){this.curDate=new moment(this.setdate),this.buildGrid()},e.prototype.ngOnChanges=function(e){this.curDate=new moment(this.setdate),this.buildGrid()},Object.defineProperty(e.prototype,"weekStartDay",{get:function(){return this.calendar.weekStartDay},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"weekDaysCount",{get:function(){return this.calendar.weekDaysCount},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentYear",{get:function(){return this.curDate.year()},set:function(e){this.curDate.year(e),this.buildGrid()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentMonth",{get:function(){return moment.months()[this.curDate.month()]},enumerable:!0,configurable:!0}),e.prototype.weekdays=function(){var e=moment.weekdaysShort();switch(this.weekStartDay){case 1:var t=e.shift();return e.push(t),e;default:return e}},e.prototype.weekdayLong=function(e){return moment.weekdays(e+this.weekStartDay)},e.prototype.notCurrentMonth=function(e){return e!==this.curDate.month()},e.prototype.isToday=function(e,t){var s=new moment;return s.year()===this.curDate.year()&&s.month()===t&&s.date()==e},e.prototype.isCurrent=function(e,t){return this.setdate&&this.curDate.year()===this.setdate.year()&&this.setdate.month()===t&&this.setdate.date()==e},e.prototype.isCurrentWeek=function(e){var t=new moment;return t.date(e[0].day),t.month(e[0].month),this.setdate.year()===this.curDate.year()&&this.setdate.week()===t.week()},e.prototype.prevMonth=function(){this.curDate.subtract(1,"months"),this.buildGrid()},e.prototype.nextMonth=function(){this.curDate.add(1,"months"),this.buildGrid()},e.prototype.goToday=function(){this.curDate=new moment,this.buildGrid()},e.prototype.pickDate=function(e,t){this.setdate.date()==e&&this.setdate.month()==t||(this.setdate||(this.setdate=new moment),this.setdate.year(this.curDate.year()),this.setdate.month(t),this.setdate.date(e),this.setdateChange.emit(this.setdate))},e.prototype.buildGrid=function(){this.currentGrid=[];var e=new moment(this.curDate);e.date(1),e.day(this.weekStartDay);for(var t=0;t<6;){for(var s=0,n=[];s<7;)n.push({day:e.date(),month:e.month()}),e.add(1,"d"),s++;this.currentGrid.push(n),t++}},__decorate([core_1.Input(),__metadata("design:type",Object)],e.prototype,"setdate",void 0),__decorate([core_1.Output(),__metadata("design:type",core_1.EventEmitter)],e.prototype,"setdateChange",void 0),e=__decorate([core_1.Component({selector:"calendar-date-picker",template:'<div class="slds-datepicker"><div class="slds-datepicker__filter slds-grid"><div class="slds-datepicker__filter--month slds-grid slds-grid--align-spread slds-grow"><div class="slds-align-middle"><button class="slds-button slds-button--icon-container" (click)="prevMonth()"><system-button-icon [icon]="\'left\'"></system-button-icon></button></div><h2 id="month" class="slds-align-middle" aria-live="assertive" aria-atomic="true">{{currentMonth}}</h2><div class="slds-align-middle"><button class="slds-button slds-button--icon-container" (click)="nextMonth()"><system-button-icon [icon]="\'right\'"></system-button-icon></button></div></div><div class="slds-shrink-none"><label class="slds-assistive-text" for="select-01">Pick a Year</label><div class="slds-select_container"><select id="select-01" class="slds-select" title="Pick a Year" [(ngModel)]="currentYear"><option>2015</option><option>2016</option><option>2017</option><option>2018</option><option>2019</option><option>2020</option></select></div></div></div><table class="slds-datepicker__month" role="grid"><thead><tr><th *ngFor="let weekday of weekdays(); let index = index" scope="col"><abbr [title]="weekdayLong(index)">{{weekday}}</abbr></th></tr></thead><tbody><tr *ngFor="let week of currentGrid" [ngClass]="{\'slds-theme--shade\': isCurrentWeek(week)}"><td *ngFor="let day of week" role="gridcell" (click)="pickDate(day.day, day.month)" [ngClass]="{\'slds-disabled-text\': notCurrentMonth(day.month), \'slds-is-today\': isToday(day.day, day.month), \'slds-is-selected\': isCurrent(day.day, day.month)}"><span class="slds-day">{{day.day}}</span></td></tr></tbody></table></div>'}),__metadata("design:paramtypes",[services_4.language,calendar])],e)}();exports.CalendarDatePicker=CalendarDatePicker;var CalendarSheetDay=function(){function e(e,t,s,n,r,a,o){this.language=e,this.broadcast=t,this.navigation=s,this.elementRef=n,this.backend=r,this.session=a,this.calendar=o,this.navigateweek=new core_1.EventEmitter,this.usersCalendars=[],this.googleCalendarVisible=!0,this.setdate={},this.sheetTimeWidth=80,this.sheetTopMargin=0,this.sheetDay={},this.sheetHours=[],this.ownerEvents=[],this.ownerMultiEvents=[],this.otherEvents=[],this.otherMultiEvents=[],this.googleEvents=[],this.googleMultiEvents=[],this.buildHours()}return Object.defineProperty(e.prototype,"allEvents",{get:function(){return this.calendar.arrangeEvents(this.ownerEvents.concat(this.otherEvents,this.googleEvents))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"allMultiEvents",{get:function(){return this.ownerMultiEvents.concat(this.otherMultiEvents,this.googleMultiEvents)},enumerable:!0,configurable:!0}),e.prototype.ngAfterViewInit=function(){this.calendarsheet.element.nativeElement.scrollTop=8*this.calendar.sheetHourHeight},e.prototype.ngOnChanges=function(e){e.setdate&&(this.sheetDay={date:e.setdate.currentValue},this.getEvents(),this.getUsersEvents(),this.getGoogleEvents(!0)),e.usersCalendars&&this.getUsersEvents(),e.googleCalendarVisible&&this.getGoogleEvents()},e.prototype.getEvents=function(){var t=this,e=new moment(this.setdate).hour(this.calendar.startHour).minute(0).second(0),s=new moment(e).add(this.calendar.endHour-this.calendar.startHour,"h");this.ownerEvents=[],this.ownerMultiEvents=[],this.calendar.loadEvents(e,s).subscribe(function(e){0<e.length&&(e=e.filter(function(e){return e.start.hour()>=t.calendar.startHour&&e.end.hour()<=t.calendar.endHour||"absence"==e.type}),t.ownerEvents=e.filter(function(e){return!e.isMulti}),t.ownerMultiEvents=e.filter(function(e){return e.isMulti}),t.ownerMultiEvents.sort(function(e,t){return"absence"==e.type?-1:0}))})},e.prototype.getGoogleEvents=function(e){var s=this;if(void 0===e&&(e=!1),this.calendar.loggedByGoogle){var t=new moment(this.setdate).hour(this.calendar.startHour).minute(0).second(0),n=new moment(t).add(this.calendar.endHour-this.calendar.startHour,"h"),r={startdate:t.format("YYYY-MM-DD HH:mm:ss"),enddate:n.format("YYYY-MM-DD HH:mm:ss")};if(this.googleEvents=[],this.googleMultiEvents=[],e)this.backend.getRequest("google/calendar/getgoogleevents",r).subscribe(function(e){if(e.events&&0<e.events.length){var t=e.events.map(function(e){return e.start=moment(e.start.dateTime).tz(moment.tz.guess()).add(moment().utcOffset(),"m"),e.end=moment(e.end.dateTime).tz(moment.tz.guess()).add(moment().utcOffset(),"m"),0<+e.end.diff(e.start,"days")&&(e.isMulti=!0),e.data={},e.data.summary_text=e.summary,e.data.assigned_user_id=null,e.color="#db4437",e.visible=s.googleCalendarVisible,e});t=t.filter(function(e){return e.start.hour()>=s.calendar.startHour&&e.end.hour()<=s.calendar.endHour}),s.calendar.calendars.google=t,s.googleEvents=t.filter(function(e){return!e.isMulti&&e.visible}),s.googleMultiEvents=t.filter(function(e){return e.isMulti&&e.visible})}});else{var a=this.calendar.calendars.google;a&&(a=a.map(function(e){return e.visible=s.googleCalendarVisible,e}),this.googleEvents=a.filter(function(e){return!e.isMulti&&e.visible&&e.start<n&&e.end>t}),this.googleMultiEvents=a.filter(function(e){return e.isMulti&&e.visible&&e.start<n&&e.end>t}))}}},e.prototype.getUsersEvents=function(){var s=this,e=new moment(this.setdate).hour(this.calendar.startHour).minute(0).second(0),n=new moment(e).add(this.calendar.endHour-this.calendar.startHour,"h");this.otherEvents=[],this.otherMultiEvents=[];for(var t=function(t){r.calendar.loadEvents(e,n,t.id).subscribe(function(e){0<e.length&&((e=e.filter(function(e){return e.start.hour()>=s.calendar.startHour&&e.end.hour()<=s.calendar.endHour})).forEach(function(e){e.color=t.color,e.visible=t.visible,e.isMulti?s.otherMultiEvents.push(e):s.otherEvents.push(e)}),s.otherEvents=s.otherEvents.filter(function(e){return e.visible}),s.otherMultiEvents=s.otherMultiEvents.filter(function(e){return e.visible}))})},r=this,a=0,o=this.calendar.usersCalendars;a<o.length;a++){t(o[a])}},e.prototype.displayDate=function(e){return this.setdate.format(e)},e.prototype.getEventStyle=function(e){var t=60*(e.start.hour()-this.calendar.startHour)+e.start.minute(),s=60*(e.end.hour()-this.calendar.startHour)+e.end.minute(),n=(this.calendarsheet.element.nativeElement.clientWidth-this.sheetTimeWidth)/(0<e.maxOverlay?e.maxOverlay:1);return{left:this.sheetTimeWidth+n*e.displayIndex+"px",width:n+"px",top:this.calendar.sheetHourHeight/60*t+"px",height:this.calendar.sheetHourHeight/60*(s-t)+"px","z-index":e.resizing?20:15,"border-bottom":e.resizing?"1px dotted #fff":0}},e.prototype.getMultiEventStyle=function(e){var t=this.multiEvents.element.nativeElement.getBoundingClientRect();return{height:this.calendar.multiEventHeight+"px",width:t.width+"px",top:t.top+this.calendar.multiEventHeight*e+"px",left:t.left+"px",padding:"1px"}},e.prototype.getMultiEventsContainerStyle=function(){return{height:this.calendar.multiEventHeight*(1<this.allMultiEvents.length?this.allMultiEvents.length:1)}},e.prototype.getTimeColStyle=function(){return{width:this.sheetTimeWidth+"px"}},e.prototype.getDayColStyle=function(){return{width:"calc(100% - "+this.sheetTimeWidth+"px)"}},e.prototype.buildHours=function(){this.sheetHours=[];for(var e=this.calendar.startHour;e<=this.calendar.endHour;)this.sheetHours.push(e),e++},e.prototype.isTodayStyle=function(){var e=new moment;return{color:e.year()===this.setdate.year()&&e.month()===this.setdate.month()&&e.date()==this.setdate.date()?"#eb7092":"inherit"}},e.prototype.getSheetStyle=function(){return{height:"calc(100vh - "+this.calendarsheet.element.nativeElement.offsetTop+"px)"}},e.prototype.getHourDividerStyle=function(e){return{top:this.sheetTopMargin+this.calendar.sheetHourHeight*e+"px"}},e.prototype.getHalfHourDividerStyle=function(e){return{top:this.sheetTopMargin+this.calendar.sheetHourHeight*e+this.calendar.sheetHourHeight/2+"px",left:this.sheetTimeWidth+"px",width:"calc(100% - "+this.sheetTimeWidth+"px)"}},e.prototype.notLastHour=function(e){return e<this.sheetHours.length},e.prototype.getHourLabelStyle=function(e){return{top:this.sheetTopMargin+this.calendar.sheetHourHeight*e+"px",width:this.sheetTimeWidth+"px"}},e.prototype.getDayDividerStyle=function(){return{left:this.sheetTimeWidth+"px",top:"0px",height:this.calendar.sheetHourHeight*this.sheetHours.length+"px"}},e.prototype.gotoWeek=function(){this.navigateweek.emit()},e.prototype.getDropTargetStyle=function(e){return{left:this.sheetTimeWidth+"px",width:"calc(100% - "+this.sheetTimeWidth+"px)",top:this.sheetTopMargin+this.calendar.sheetHourHeight*e+"px",height:this.calendar.sheetHourHeight+"px"}},__decorate([core_1.Output(),__metadata("design:type",core_1.EventEmitter)],e.prototype,"navigateweek",void 0),__decorate([core_1.ViewChild("calendarsheet",{read:core_1.ViewContainerRef}),__metadata("design:type",core_1.ViewContainerRef)],e.prototype,"calendarsheet",void 0),__decorate([core_1.ViewChild("multievents",{read:core_1.ViewContainerRef}),__metadata("design:type",core_1.ViewContainerRef)],e.prototype,"multiEvents",void 0),__decorate([core_1.Input("userscalendars"),__metadata("design:type",Array)],e.prototype,"usersCalendars",void 0),__decorate([core_1.Input("googlecalendarvisible"),__metadata("design:type",Boolean)],e.prototype,"googleCalendarVisible",void 0),__decorate([core_1.Input(),__metadata("design:type",Object)],e.prototype,"setdate",void 0),e=__decorate([core_1.Component({selector:"calendar-sheet-day",template:'<div class="slds-border--bottom"><div class="slds-grid"><div class="slds-align--absolute-center slds-p-vertical--x-small" [ngStyle]="getTimeColStyle()"><system-utility-icon [icon]="\'clock\'" [size]="\'x-small\'"></system-utility-icon></div><div class="slds-size--1-of-1 slds-border--left slds-p-top--xx-small" [ngStyle]="getDayColStyle()"><div class="slds-text-body--regular slds-p-left--x-small" [ngStyle]="isTodayStyle()">{{displayDate(\'ddd\')}}</div><div style="font-size: 2.5rem;line-height: 2.5rem;" class="slds-p-left--x-small slds-p-bottom--xx-small" [ngStyle]="isTodayStyle()">{{displayDate(\'D\')}}</div><div #multievents class="slds-text-align--center slds-border--top slds-p-around--xxx-small slds-text-body--small" [ngStyle]="getMultiEventsContainerStyle()"><ng-container *ngFor="let event of allMultiEvents; let index = index"><calendar-sheet-event [ngStyle]="getMultiEventStyle(index)" [event]="event"></calendar-sheet-event></ng-container></div></div></div></div><div #calendarsheet [ngStyle]="getSheetStyle()" class="slds-scrollable slds-p-vertical--medium slds-is-relative"><ng-container *ngFor="let sheetHour of sheetHours; let index = index"><div class="slds-is-absolute slds-border--top slds-size--1-of-1" [ngStyle]="getHourDividerStyle(index)"></div><ng-container *ngIf="notLastHour(index)"><div class="slds-is-absolute slds-border--top" [ngStyle]="getHalfHourDividerStyle(index)"></div><div class="slds-is-absolute slds-text-align--center" [ngStyle]="getHourLabelStyle(index)">{{sheetHour}}:00</div><calendar-sheet-drop-target [hour]="sheetHour" class="slds-is-absolute" [ngStyle]="getDropTargetStyle(index)"></calendar-sheet-drop-target></ng-container></ng-container><ng-container><div class="slds-is-absolute slds-border--left" [ngStyle]="getDayDividerStyle()"></div></ng-container><ng-container *ngFor="let event of allEvents"><calendar-sheet-event [ngStyle]="getEventStyle(event)" [event]="event"></calendar-sheet-event></ng-container></div>'}),__metadata("design:paramtypes",[services_4.language,services_5.broadcast,services_6.navigation,core_1.ElementRef,services_7.backend,services_8.session,calendar])],e)}();exports.CalendarSheetDay=CalendarSheetDay;var CalendarSheetWeek=function(){function e(e,t,s,n,r,a){this.language=e,this.broadcast=t,this.navigation=s,this.elementRef=n,this.backend=r,this.calendar=a,this.navigateday=new core_1.EventEmitter,this.sheetDays=[],this.usersCalendars=[],this.googleCalendarVisible=!0,this.setdate={},this.sheetTimeWidth=80,this.sheetHours=[],this.sheetTopMargin=0,this.ownerEvents=[],this.ownerMultiEvents=[],this.otherEvents=[],this.otherMultiEvents=[],this.googleEvents=[],this.googleMultiEvents=[],this.buildHours(),this.sheetDays=this.buildSheetDays()}return Object.defineProperty(e.prototype,"offset",{get:function(){return moment().utcOffset()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"allEvents",{get:function(){return this.calendar.arrangeEvents(this.ownerEvents.concat(this.otherEvents,this.googleEvents))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"allMultiEvents",{get:function(){return this.ownerMultiEvents.concat(this.otherMultiEvents,this.googleMultiEvents)},enumerable:!0,configurable:!0}),e.prototype.ngAfterViewInit=function(){this.calendarsheet.element.nativeElement.scrollTop=8*this.calendar.sheetHourHeight},e.prototype.ngOnChanges=function(e){e.setdate&&(this.sheetDays=this.buildSheetDays(),this.getEvents(),this.getUsersEvents(),this.getGoogleEvents(!0)),e.usersCalendars&&this.getUsersEvents(),e.googleCalendarVisible&&this.getGoogleEvents()},e.prototype.getEvents=function(){var t=this,e=new moment(this.setdate).day(0).hour(this.calendar.startHour).minute(0).second(0),s=new moment(e).add(moment.duration(this.calendar.weekDaysCount,"d")).hour(this.calendar.endHour);this.ownerEvents=[],this.ownerMultiEvents=[],this.calendar.loadEvents(e,s).subscribe(function(e){0<e.length&&(e=e.filter(function(e){return e.start.hour()>=t.calendar.startHour&&e.end.hour()<=t.calendar.endHour||"absence"==e.type}),t.ownerEvents=e.filter(function(e){return!e.isMulti}),t.ownerMultiEvents=e.filter(function(e){return e.isMulti}),t.ownerMultiEvents.sort(function(e,t){return"absence"==e.type?-1:0}))})},e.prototype.getGoogleEvents=function(e){var s=this;if(void 0===e&&(e=!1),this.calendar.loggedByGoogle){var t=new moment(this.setdate).day(0).hour(this.calendar.startHour).minute(0).second(0),n=new moment(t).add(moment.duration(this.calendar.weekDaysCount,"d")).hour(this.calendar.endHour),r={startdate:t.format("YYYY-MM-DD HH:mm:ss"),enddate:n.format("YYYY-MM-DD HH:mm:ss")};if(this.googleEvents=[],this.googleMultiEvents=[],e)this.backend.getRequest("google/calendar/getgoogleevents",r).subscribe(function(e){if(e.events&&0<e.events.length){var t=e.events.map(function(e){return e.start=moment(e.start.dateTime).tz(moment.tz.guess()).add(moment().utcOffset(),"m"),e.end=moment(e.end.dateTime).tz(moment.tz.guess()).add(moment().utcOffset(),"m"),0<+e.end.diff(e.start,"days")&&(e.isMulti=!0),e.data={},e.data.summary_text=e.summary,e.data.assigned_user_id=null,e.color="#db4437",e.visible=s.googleCalendarVisible,e});t=t.filter(function(e){return e.start.hour()>=s.calendar.startHour&&e.end.hour()<=s.calendar.endHour}),s.calendar.calendars.google=t,s.googleEvents=t.filter(function(e){return!e.isMulti&&e.visible}),s.googleMultiEvents=t.filter(function(e){return e.isMulti&&e.visible})}});else{var a=this.calendar.calendars.google;a&&(a=a.map(function(e){return e.visible=s.googleCalendarVisible,e}),this.googleEvents=a.filter(function(e){return!e.isMulti&&e.visible&&e.start<n&&e.end>t}),this.googleMultiEvents=a.filter(function(e){return e.isMulti&&e.visible&&e.start<n&&e.end>t}))}}},e.prototype.getUsersEvents=function(){var s=this,e=new moment(this.setdate).day(0).hour(this.calendar.startHour).minute(0).second(0),n=new moment(e).add(moment.duration(this.calendar.weekDaysCount,"d")).hour(this.calendar.endHour);this.otherEvents=[],this.otherMultiEvents=[];for(var t=function(t){r.calendar.loadEvents(e,n,t.id).subscribe(function(e){0<e.length&&((e=e.filter(function(e){return e.start.hour()>=s.calendar.startHour&&e.end.hour()<=s.calendar.endHour})).forEach(function(e){e.color=t.color,e.visible=t.visible,e.isMulti?s.otherMultiEvents.push(e):s.otherEvents.push(e)}),s.otherEvents=s.otherEvents.filter(function(e){return e.visible}),s.otherMultiEvents=s.otherMultiEvents.filter(function(e){return e.visible}))})},r=this,a=0,o=this.calendar.usersCalendars;a<o.length;a++){t(o[a])}},e.prototype.buildSheetDays=function(){for(var e=[],t=0,s=this.calendar.weekStartDay;t<this.calendar.weekDaysCount;){var n=new moment(this.setdate);n.day(s),e.push({index:t,date:n}),t++,s++}return e},e.prototype.isTodayStyle=function(e){var t=new moment;return{color:t.year()===e.year()&&t.month()===e.month()&&t.date()==e.date()?this.calendar.todayColor:"inherit"}},e.prototype.getEventStyle=function(e){var t=e.start.day()-this.calendar.weekStartDay,s=60*(e.start.hour()-this.calendar.startHour)+e.start.minute(),n=60*(e.end.hour()-this.calendar.startHour)+e.end.minute(),r=(this.calendarsheet.element.nativeElement.clientWidth-this.sheetTimeWidth)/this.calendar.weekDaysCount/(0<e.maxOverlay?e.maxOverlay:1);return{left:this.sheetTimeWidth+(this.calendarsheet.element.nativeElement.clientWidth-this.sheetTimeWidth)/this.calendar.weekDaysCount*t+r*e.displayIndex+"px",width:r+"px",top:this.calendar.sheetHourHeight/60*s+"px",height:this.calendar.sheetHourHeight/60*(n-s)+"px","z-index":e.resizing?20:15,"border-bottom":e.resizing?"1px dotted #fff":0}},e.prototype.getMultiEventStyle=function(e,t){if(!this.multiEvents)return{};var s=this.multiEvents.element.nativeElement.getBoundingClientRect(),n=new moment(this.setdate).day(0).hour(0).minute(0).second(0),r=new moment(n).add(moment.duration(this.calendar.weekDaysCount,"d")),a=0<+e.start.diff(n,"days")?+e.start.diff(n,"days"):0,o=0<+e.end.diff(r,"days")?0:Math.abs(+e.end.diff(r,"days")),i=s.left+a*s.width;return{width:(this.calendar.weekDaysCount-(a+o))*s.width+"px",left:i+"px",height:this.calendar.multiEventHeight+"px",top:s.top+this.calendar.multiEventHeight*t+"px",padding:"2px"}},e.prototype.getMultiEventsContainerStyle=function(){return{height:this.calendar.multiEventHeight*(1<this.allMultiEvents.length?this.allMultiEvents.length:1)}},e.prototype.displayDate=function(e,t){return t.format(e)},e.prototype.getTimeColStyle=function(){return{width:this.sheetTimeWidth+"px"}},e.prototype.getDayColStyle=function(){return{width:"calc((100% - "+this.sheetTimeWidth+"px) / "+this.calendar.weekDaysCount+")"}},e.prototype.buildHours=function(){this.sheetHours=[];for(var e=this.calendar.startHour;e<=this.calendar.endHour;)this.sheetHours.push(e),e++},e.prototype.getSheetStyle=function(){return{height:"calc(100vh - "+this.calendarsheet.element.nativeElement.offsetTop+"px)"}},e.prototype.getHourDividerStyle=function(e){return{top:this.sheetTopMargin+this.calendar.sheetHourHeight*e+"px"}},e.prototype.getHalfHourDividerStyle=function(e){return{top:this.sheetTopMargin+this.calendar.sheetHourHeight*e+this.calendar.sheetHourHeight/2+"px",left:this.sheetTimeWidth+"px",width:"calc(100% - "+this.sheetTimeWidth+"px)"}},e.prototype.notLastHour=function(e){return e<this.sheetHours.length},e.prototype.getHourLabelStyle=function(e){return{top:this.sheetTopMargin+this.calendar.sheetHourHeight*e+"px",width:this.sheetTimeWidth+"px"}},e.prototype.getDayDividerStyle=function(e){return{left:this.sheetTimeWidth+(this.calendarsheet.element.nativeElement.clientWidth-this.sheetTimeWidth)/this.calendar.weekDaysCount*e+"px",top:"0px",height:this.calendar.sheetHourHeight*this.sheetHours.length+"px"}},e.prototype.gotoDay=function(e){var t=moment(this.setdate);t.day(e),this.navigateday.emit(t)},e.prototype.getDropTargetStyle=function(e,t){return{left:this.sheetTimeWidth+(this.calendarsheet.element.nativeElement.clientWidth-this.sheetTimeWidth)/this.calendar.weekDaysCount*t+"px",width:(this.calendarsheet.element.nativeElement.clientWidth-this.sheetTimeWidth)/this.calendar.weekDaysCount+"px",top:this.sheetTopMargin+this.calendar.sheetHourHeight*e+"px",height:this.calendar.sheetHourHeight+"px"}},__decorate([core_1.Output(),__metadata("design:type",core_1.EventEmitter)],e.prototype,"navigateday",void 0),__decorate([core_1.ViewChild("calendarsheet",{read:core_1.ViewContainerRef}),__metadata("design:type",core_1.ViewContainerRef)],e.prototype,"calendarsheet",void 0),__decorate([core_1.ViewChild("multievents",{read:core_1.ViewContainerRef}),__metadata("design:type",core_1.ViewContainerRef)],e.prototype,"multiEvents",void 0),__decorate([core_1.Input("userscalendars"),__metadata("design:type",Array)],e.prototype,"usersCalendars",void 0),__decorate([core_1.Input("googlecalendarvisible"),__metadata("design:type",Boolean)],e.prototype,"googleCalendarVisible",void 0),__decorate([core_1.Input(),__metadata("design:type",Object)],e.prototype,"setdate",void 0),e=__decorate([core_1.Component({selector:"calendar-sheet-week",template:'<div class="slds-border--bottom"><div class="slds-grid" style="margin-right: 17px"><div class="slds-align--absolute-center slds-p-vertical--x-small" [ngStyle]="getTimeColStyle()"><system-utility-icon [icon]="\'clock\'" [size]="\'x-small\'" class="slds-m-right--xxx-small"></system-utility-icon>{{offset}}</div><div class="slds-size--1-of-1 slds-border--left slds-p-top--xx-small" [ngStyle]="getDayColStyle()" *ngFor="let sheetDay of sheetDays; let last = last; let first = first" [ngClass]="last ? \'slds-border--right\' : \'\'"><div class="slds-text-body--regular slds-p-left--x-small" [ngStyle]="isTodayStyle(sheetDay.date)">{{displayDate(\'ddd\', sheetDay.date)}}</div><div style="font-size: 2.5rem;line-height: 2.5rem;" class="slds-p-left--x-small slds-p-bottom--xx-small slds-border--bottom"><a href="javascript:void(0);" class="slds-text-link--reset" (click)="gotoDay(sheetDay.index)" [ngStyle]="isTodayStyle(sheetDay.date)">{{displayDate(\'D\',sheetDay.date)}}</a></div><div #multievents *ngIf="first" class="slds-text-align--center slds-text-body--small slds-p-around--xxx-small" [ngStyle]="getMultiEventsContainerStyle()"><ng-container *ngFor="let event of allMultiEvents; let eventIndex = index"><calendar-sheet-event [ngStyle]="getMultiEventStyle(event, eventIndex)" [event]="event"></calendar-sheet-event></ng-container></div></div></div></div><div #calendarsheet [ngStyle]="getSheetStyle()" class="slds-scrollable slds-is-relative"><ng-container *ngFor="let sheetHour of sheetHours; let index = index"><div class="slds-is-absolute slds-border--top slds-size--1-of-1" [ngStyle]="getHourDividerStyle(index)"></div><ng-container *ngIf="notLastHour(index)"><div class="slds-is-absolute slds-border--top" [ngStyle]="getHalfHourDividerStyle(index)"></div><div class="slds-is-absolute slds-text-align--center" [ngStyle]="getHourLabelStyle(index)">{{sheetHour}}:00</div><calendar-sheet-drop-target [hour]="sheetHour" [day]="sheetDay" class="slds-is-absolute" *ngFor="let sheetDay of sheetDays" [ngStyle]="getDropTargetStyle(index, sheetDay.index)">{{sheetHour + \',\' + sheetDay.index}}</calendar-sheet-drop-target></ng-container></ng-container><ng-container *ngFor="let sheetDay of sheetDays"><div class="slds-is-absolute slds-border--left" [ngStyle]="getDayDividerStyle(sheetDay.index)"></div></ng-container><ng-container *ngFor="let event of allEvents"><calendar-sheet-event [ngStyle]="getEventStyle(event)" [event]="event"></calendar-sheet-event></ng-container></div>'}),__metadata("design:paramtypes",[services_4.language,services_5.broadcast,services_6.navigation,core_1.ElementRef,services_7.backend,calendar])],e)}();exports.CalendarSheetWeek=CalendarSheetWeek;var CalendarSheetMonth=function(){function e(e,t,s,n,r,a,o,i){var l=this;this.language=e,this.broadcast=t,this.navigation=s,this.elementRef=n,this.backend=r,this.cdRef=a,this.renderer=o,this.calendar=i,this.navigateday=new core_1.EventEmitter,this.usersCalendars=[],this.googleCalendarVisible=!0,this.setdate={},this.currentGrid=[],this.eventHeight=25,this.moreHeight=20,this.maxEventsPerBox=1,this.resizeHandler={},this.ownerEvents=[],this.otherEvents=[],this.googleEvents=[],this.resizeHandler=this.renderer.listen("window","resize",function(){return l.setMaxEvents()})}return Object.defineProperty(e.prototype,"allEvents",{get:function(){return this.ownerEvents.concat(this.otherEvents,this.googleEvents)},enumerable:!0,configurable:!0}),e.prototype.ngAfterViewInit=function(){this.setMaxEvents()},e.prototype.ngOnChanges=function(e){e.setdate&&(this.buildGrid(),this.getEvents(),this.getUsersEvents(),this.getGoogleEvents(!0)),e.usersCalendars&&this.getUsersEvents(),e.googleCalendarVisible&&this.getGoogleEvents()},e.prototype.setMaxEvents=function(){var e=this.boxContainer.element.nativeElement.clientHeight,t=this.dayContainer.element.nativeElement.clientHeight;this.maxEventsPerBox=Math.floor((e-t-this.moreHeight)/this.eventHeight),this.cdRef.detectChanges()},e.prototype.getSheetDays=function(){for(var e=[],t=0,s=this.calendar.weekStartDay,n=moment.weekdaysShort();t<this.calendar.weekDaysCount;)e.push({index:t,text:n[s]}),t++,6<++s&&(s=0);return e},e.prototype.getEvents=function(){var t=this,e=new moment(this.setdate).date(1).hour(this.calendar.startHour).minute(0).second(0),s=new moment(e).add(moment.duration(1,"M")).hour(this.calendar.endHour);this.ownerEvents=[],this.calendar.loadEvents(e,s).subscribe(function(e){0<e.length&&(t.ownerEvents=e,t.reArrangeEvents(t.ownerEvents,"owner"))})},e.prototype.getGoogleEvents=function(e){var s=this;if(void 0===e&&(e=!1),this.calendar.loggedByGoogle){var t=new moment(this.setdate).date(1).hour(this.calendar.startHour).minute(0).second(0),n=new moment(t).add(moment.duration(1,"M")).hour(this.calendar.endHour),r={startdate:t.format("YYYY-MM-DD HH:mm:ss"),enddate:n.format("YYYY-MM-DD HH:mm:ss")};if(this.googleEvents=[],e)this.backend.getRequest("google/calendar/getgoogleevents",r).subscribe(function(e){if(e.events&&0<e.events.length){var t=e.events.map(function(e){return e.start=moment(e.start.dateTime).tz(moment.tz.guess()).add(moment().utcOffset(),"m"),e.end=moment(e.end.dateTime).tz(moment.tz.guess()).add(moment().utcOffset(),"m"),0<+e.end.diff(e.start,"days")&&(e.isMulti=!0),e.data={},e.data.summary_text=e.summary,e.data.assigned_user_id=null,e.color="#db4437",e.visible=s.googleCalendarVisible,e});s.calendar.calendars.google=t,s.googleEvents=t,s.reArrangeEvents(s.googleEvents,"google"),s.googleEvents=t.filter(function(e){return e.visible})}});else{var a=this.calendar.calendars.google;a&&(a=a.map(function(e){return e.visible=s.googleCalendarVisible,e}),this.googleEvents=a.filter(function(e){return e.start<n&&e.end>t}),this.reArrangeEvents(this.googleEvents,"google"),this.googleEvents=a.filter(function(e){return e.visible}))}}},e.prototype.getUsersEvents=function(){var s=this,e=new moment(this.setdate).date(1).hour(this.calendar.startHour).minute(0).second(0),n=new moment(e).add(moment.duration(1,"M")).hour(this.calendar.endHour);this.currentGrid.forEach(function(e){return e.forEach(function(e){return e.items=e.items.filter(function(e){return"users"!=e.category})})}),this.otherEvents=[];for(var t=function(t){r.calendar.loadEvents(e,n,t.id).subscribe(function(e){0<e.length&&(e.forEach(function(e){e.color=t.color,e.visible=t.visible,s.otherEvents.push(e)}),s.reArrangeEvents(s.otherEvents,"users"),s.otherEvents=s.otherEvents.filter(function(e){return e.visible}))})},r=this,a=0,o=this.calendar.usersCalendars;a<o.length;a++){t(o[a])}},e.prototype.reArrangeEvents=function(e,r){for(var a=0;a<this.currentGrid.length;a++)for(var t=function(t){t.hasOwnProperty("weeksI")||(t.weeksI=[]);for(var e=0;e<o.currentGrid[a].length;e++){for(var s=o.currentGrid[a][e],n=moment(t.start);n.isBefore(t.end);n.add(1,"days"))n.date()==s.day&&s.month==n.month()&&(t.hasOwnProperty("startI")||(t.startI=e),s.items.some(function(e){return e.id==t.id})||(t.category=r,s.items.push(t)),-1==t.weeksI.indexOf(a)&&t.weeksI.push(a),t.endI=e);s.items.sort(function(e,t){return e.start<t.start||e.data.duration_hours>t.data.duration_hours?-1:e.data.duration_hours<=24?1:0}),s.items=s.items.filter(function(e){return e.hasOwnProperty("visible")&&e.visible||!e.hasOwnProperty("visible")})}},o=this,s=0,n=e;s<n.length;s++){t(n[s])}},e.prototype.gotoDay=function(e){var t=moment(this.setdate);t.month(e.month).date(e.day),this.navigateday.emit(t)},e.prototype.getDayColStyle=function(e){var t=new moment,s=t.format("ddd"),n=this.calendar.calendarDate;return{width:"calc(100% / "+this.calendar.weekDaysCount+")",color:n.year()==t.year()&&n.month()==t.month()&&s==e?this.calendar.todayColor:"inherit","font-weight":n.year()==t.year()&&n.month()==t.month()&&s==e?"600":"inherit"}},e.prototype.getSheetStyle=function(){return{height:"calc(100vh - "+(this.calendarsheet.element.nativeElement.offsetTop+20)+"px)"}},e.prototype.getDayDividerStyle=function(e){return{left:this.calendarsheet.element.nativeElement.clientWidth/this.calendar.weekDaysCount*e+"px",top:"0px",height:"100%"}},e.prototype.buildGrid=function(){this.currentGrid=[];var e=new moment(this.setdate);e.date(1),e.day(this.calendar.weekStartDay);for(var t=0;t<6;){var s=0,n=[];if(e.year()<this.setdate.year()||e.month()<=this.setdate.month()){for(;s<this.calendar.weekDaysCount;){n.push({day:e.date(),month:e.month(),items:[]});var r=7-this.calendar.weekDaysCount;s==this.calendar.weekDaysCount-1&&this.calendar.weekDaysCount<7&&e.add(r,"d"),e.add(1,"d"),s++}this.currentGrid.push(n)}t++}},e.prototype.notLastWeek=function(e){return e<this.currentGrid.length},e.prototype.notThisMonth=function(e){return e!==this.setdate.month()},e.prototype.getWeekDividerStyle=function(e){return{top:"calc((100% / "+this.currentGrid.length+") * "+e+" )"}},e.prototype.getBoxStyle=function(e,t,s){return{left:this.calendarsheet.element.nativeElement.clientWidth/this.calendar.weekDaysCount*t+"px",top:"calc((100% / "+this.currentGrid.length+") * "+e+" )",color:this.notThisMonth(s)?"#9faab5":"inherit","background-color":this.notThisMonth(s)?"#f4f6f9":"transparent",width:this.calendarsheet.element.nativeElement.clientWidth/this.calendar.weekDaysCount+"px",height:"calc(100% / "+this.currentGrid.length+")"}},e.prototype.getEventStyle=function(s,e){var n=this,r=0,a=null,o=0,i="block";this.currentGrid[e].some(function(e,t){-1<e.items.indexOf(s)&&(null==a&&(a=t),r=t,(o=o>e.items.indexOf(s)?o:e.items.indexOf(s))>=n.maxEventsPerBox&&(i="none"))});var t=r-a,l=this.calendarsheet.element.nativeElement,d=null!=this.dayContainer?this.dayContainer.element.nativeElement.clientHeight:0;return{left:l.clientWidth/this.calendar.weekDaysCount*a,width:l.clientWidth/this.calendar.weekDaysCount+l.clientWidth/this.calendar.weekDaysCount*t,top:d+l.clientHeight/this.currentGrid.length*e+this.eventHeight*o,height:this.eventHeight,display:i}},e.prototype.isTodayStyle=function(e,t){var s=this.calendar.calendarDate.year(),n=new moment;return{"background-color":s===n.year()&&n.month()===t&&n.date()==e?this.calendar.todayColor:"inherit","border-radius":"50%","line-height":"1rem","text-align":"center","font-size":".7rem",color:s===n.year()&&n.month()===t&&n.date()==e?"#fff":"inherit",width:"1rem",height:"1rem",display:"block"}},__decorate([core_1.Output(),__metadata("design:type",core_1.EventEmitter)],e.prototype,"navigateday",void 0),__decorate([core_1.ViewChild("calendarsheet",{read:core_1.ViewContainerRef}),__metadata("design:type",core_1.ViewContainerRef)],e.prototype,"calendarsheet",void 0),__decorate([core_1.ViewChild("daycontainer",{read:core_1.ViewContainerRef}),__metadata("design:type",core_1.ViewContainerRef)],e.prototype,"dayContainer",void 0),__decorate([core_1.ViewChild("boxcontainer",{read:core_1.ViewContainerRef}),__metadata("design:type",core_1.ViewContainerRef)],e.prototype,"boxContainer",void 0),__decorate([core_1.ViewChild("morecontainer",{read:core_1.ViewContainerRef}),__metadata("design:type",core_1.ViewContainerRef)],e.prototype,"moreContainer",void 0),__decorate([core_1.Input("userscalendars"),__metadata("design:type",Array)],e.prototype,"usersCalendars",void 0),__decorate([core_1.Input("googlecalendarvisible"),__metadata("design:type",Boolean)],e.prototype,"googleCalendarVisible",void 0),__decorate([core_1.Input(),__metadata("design:type",Object)],e.prototype,"setdate",void 0),e=__decorate([core_1.Component({selector:"calendar-sheet-month",template:'<div class="slds-border--bottom"><div class="slds-grid"><div class="slds-text-align--center slds-p-vertical--small slds-border--left" *ngFor="let sheetDay of getSheetDays()" [ngStyle]="getDayColStyle(sheetDay.text)">{{sheetDay.text}}</div></div></div><div #calendarsheet [ngStyle]="getSheetStyle()" class="slds-scrollable slds-p-vertical--medium slds-is-relative"><ng-container *ngFor="let sheetWeek of currentGrid; let i = index"><div #boxcontainer *ngFor="let sheetDay of sheetWeek; let j = index" class="slds-is-absolute slds-truncate" [ngStyle]="getBoxStyle(i, j, sheetDay.month)"><div #daycontainer class="slds-p-around--xx-small"><a href="javascript:void(0);" class="slds-text-link--reset" (click)="gotoDay(sheetDay)" [ngStyle]="isTodayStyle(sheetDay.day, sheetDay.month)">{{sheetDay.day}}</a></div><div class="slds-grid slds-grid--align-center slds-is-absolute" style="bottom: 0;width: 100%" [style.height]="moreHeight"><calendar-more-button *ngIf="sheetDay.items.length > 0 && sheetDay.items.length > maxEventsPerBox" [moreevents]="sheetDay.items"></calendar-more-button></div></div><div *ngIf="notLastWeek(i)" class="slds-is-absolute slds-border--bottom slds-size--1-of-1" [ngStyle]="getWeekDividerStyle(i)"></div></ng-container><ng-container *ngFor="let sheetDay of getSheetDays()"><div class="slds-is-absolute slds-border--left" [ngStyle]="getDayDividerStyle(sheetDay.index)"></div></ng-container><ng-container *ngFor="let event of allEvents"><ng-container *ngFor="let week of event.weeksI"><calendar-sheet-event [event]="event" [isMonthSheet]="true" style="padding: 1px 0" [ngStyle]="getEventStyle(event, week)"></calendar-sheet-event></ng-container></ng-container></div>'}),__metadata("design:paramtypes",[services_4.language,services_5.broadcast,services_6.navigation,core_1.ElementRef,services_7.backend,core_1.ChangeDetectorRef,core_1.Renderer2,calendar])],e)}();exports.CalendarSheetMonth=CalendarSheetMonth;var CalendarSheetEvent=function(){function e(e,t,s,n,r,a,o){this.language=e,this.metadata=t,this.broadcast=s,this.calendar=n,this.elementRef=r,this.model=a,this.renderer=o,this.rearrange=new core_1.EventEmitter,this.fields=[],this.event={},this.isMonthSheet=!1,this.mouseMoveListener=void 0,this.mouseUpListener=void 0,this.mouseStart=void 0,this.mouseLast=void 0,this.lastMoveTimeSpan=0}return e.prototype.ngOnInit=function(){this.model.module=this.event.module,this.model.id=this.event.id,this.model.data=this.event.data},Object.defineProperty(e.prototype,"owner",{get:function(){return this.calendar.owner},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"canEdit",{get:function(){return this.owner==this.event.data.assigned_user_id},enumerable:!0,configurable:!0}),e.prototype.getEventStyle=function(){return{"background-color":this.event.color?this.event.color:"rgb(3, 155, 229)"}},e.prototype.dragStart=function(e){this.canEdit&&(this.event.dragging=!0)},e.prototype.dragEnd=function(e){this.event.dragging=!1},e.prototype.onMouseDown=function(e){var t=this;this.mouseStart=e,this.mouseLast=e,this.event.resizing=!0,this.mouseUpListener=this.renderer.listen("document","mouseup",function(e){return t.onMouseUp()}),this.mouseMoveListener=this.renderer.listen("document","mousemove",function(e){return t.onMouseMove(e)}),e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),e.cancelBubble=!0,e.returnValue=!1},e.prototype.onMouseMove=function(e){if(this.canEdit){this.mouseLast=e;var t=this.mouseLast.pageY-this.mouseStart.pageY,s=Math.floor(t/15);if(this.lastMoveTimeSpan!==s){this.lastMoveTimeSpan=s;var n=new moment(this.event.start).add(60*this.event.data.duration_hours+this.event.data.duration_minutes+15*this.lastMoveTimeSpan,"m");this.event.start.hours()===n.hours()&&this.event.start.minutes()===n.minutes()||n.hours()<this.event.start.hours()?(this.event.end=new moment(this.event.start).add(15,"m"),this.lastMoveTimeSpan=this.lastMoveTimeSpan-(60*this.event.data.duration_hours+this.event.data.duration_minutes+15*this.lastMoveTimeSpan)/15+1):this.event.end=n}}},e.prototype.onMouseUp=function(){var t=this;if(this.canEdit){if(this.mouseUpListener(),this.mouseMoveListener(),this.mouseLast.pageY!=this.mouseStart.pageY){var e=60*+this.event.data.duration_hours+ +this.event.data.duration_minutes+15*this.lastMoveTimeSpan;this.event.data.duration_hours=Math.floor(e/60),this.event.data.duration_minutes=e-60*this.event.data.duration_hours,this.model.data.duration_minutes=this.event.data.duration_minutes,this.model.data.duration_hours=this.event.data.duration_hours,this.event.saving=!0,this.model.save().subscribe(function(e){t.event.saving=!1}),this.rearrange.emit()}this.mouseStart=void 0,this.mouseLast=void 0,this.event.resizing=!1,this.lastMoveTimeSpan=0}},__decorate([core_1.Output(),__metadata("design:type",core_1.EventEmitter)],e.prototype,"rearrange",void 0),__decorate([core_1.Input(),__metadata("design:type",Object)],e.prototype,"event",void 0),__decorate([core_1.Input(),__metadata("design:type",Boolean)],e.prototype,"isMonthSheet",void 0),e=__decorate([core_1.Component({selector:"calendar-sheet-event",template:'<div class="slds-m-around--xxx-small slds-p-horizontal--xx-small" [ngClass]="event.saving ? \'slds-p-vertical--xx-small\': null" style="height:100%; border-radius: 2px;" [ngStyle]="getEventStyle()" [draggable]="canEdit && !event.isMulti && !isMonthSheet"><ng-container *ngIf="!event.saving; else saving"><div class="slds-grid slds-grid--align-spread"><div class="slds-truncate" style="height: 100%;"><calendar-event-summary [ismulti]="event.isMulti" [isabsence]="event.type == \'absence\'"></calendar-event-summary></div><object-action-menu *ngIf="canEdit" class="slds-m-top--xxx-small" [buttonsize]="\'xx-small\'"></object-action-menu></div><div *ngIf="!event.isMulti && !isMonthSheet && canEdit" draggable="false" class="slds-is-absolute" style="bottom: 0; left: calc(50% - 8px);cursor: ns-resize;" (mousedown)="onMouseDown($event)"><system-utility-icon colorclass="slds-icon-text-white" icon="threedots" size="x-small"></system-utility-icon></div></ng-container><ng-template #saving><system-spinner inverse="true" style="opacity: 0.5;"></system-spinner></ng-template></div>',providers:[services_2.model,services_10.view],host:{class:"slds-is-absolute slds-p-bottom--xxx-small","(dragstart)":"this.dragStart($event)","(dragend)":"this.dragEnd($event)"}}),__metadata("design:paramtypes",[services_4.language,services_1.metadata,services_5.broadcast,calendar,core_1.ElementRef,services_2.model,core_1.Renderer2])],e)}();exports.CalendarSheetEvent=CalendarSheetEvent;var CalendarEventSummary=function(){function e(e,t){this.model=e,this.userpreferences=t,this.isMulti=!1,this.isAbsence=!1}return Object.defineProperty(e.prototype,"startHour",{get:function(){return this.model.data.date_start?moment(this.model.data.date_start).tz(moment.tz.guess()).add(moment().utcOffset(),"m").format(this.userpreferences.getTimeFormat()):void 0},enumerable:!0,configurable:!0}),__decorate([core_1.Input("ismulti"),__metadata("design:type",Boolean)],e.prototype,"isMulti",void 0),__decorate([core_1.Input("isabsence"),__metadata("design:type",Boolean)],e.prototype,"isAbsence",void 0),e=__decorate([core_1.Component({selector:"calendar-event-summary",template:'<span *ngIf="model.module" modelPopOver class="slds-text-link--reset slds-text-color--inverse">{{model.data.summary_text}}</span> <span *ngIf="!model.module" [title]="model.data.summary_text" class="slds-text-link--reset slds-text-color--inverse">{{model.data.summary_text}}</span> <span *ngIf="isMulti && startHour && !isAbsence" class="slds-text-color--inverse">, {{startHour}}</span>'}),__metadata("design:paramtypes",[services_2.model,userpreferences])],e)}();exports.CalendarEventSummary=CalendarEventSummary;var CalendarSheetDropTarget=function(){function e(e,t){this.calendar=e,this.model=t,this.rearrange=new core_1.EventEmitter,this.hour="",this.day=void 0,this.isDropTarget=!1}return Object.defineProperty(e.prototype,"content",{get:function(){return this.hour+" "+this.day},enumerable:!0,configurable:!0}),e.prototype.getClass=function(){return this.isDropTarget?"slds-is-absolute slds-theme--shade":"slds-is-absolute"},e.prototype.dragOver=function(e){e.preventDefault()},e.prototype.dragEnter=function(e){this.isDropTarget=!0},e.prototype.dragLeave=function(e){this.isDropTarget=!1},e.prototype.drop=function(e){var t=null;if(this.calendar.getEvents().some(function(e){if(e.dragging)return t=e,!0}),t){t.dragging=!1;moment().utcOffset();this.day&&(t.data.date_start.date(this.day.date.date()),t.data.date_start.month(this.day.date.month()),t.data.date_start.year(this.day.date.year())),t.data.date_start.hour(this.hour),t.data.date_start.minutes(0),t.data.date_end=new moment(t.data.date_start).add(t.data.duration_minutes+60*t.data.duration_hours,"m"),this.day&&(t.start.date(this.day.date.date()),t.start.month(this.day.date.month()),t.start.year(this.day.date.year())),t.start.hour(this.hour),t.start.minutes(0),t.end=new moment(t.start).add(t.data.duration_minutes+60*t.data.duration_hours,"m"),this.saveEvent(t),this.rearrange.emit()}this.isDropTarget=!1,e.preventDefault()},e.prototype.saveEvent=function(t){this.model.module=t.module,this.model.id=t.id,this.model.data=t.data,t.saving=!0,this.model.save().subscribe(function(e){t.saving=!1})},__decorate([core_1.Output(),__metadata("design:type",core_1.EventEmitter)],e.prototype,"rearrange",void 0),__decorate([core_1.Input(),__metadata("design:type",Object)],e.prototype,"hour",void 0),__decorate([core_1.Input(),__metadata("design:type",Object)],e.prototype,"day",void 0),e=__decorate([core_1.Component({selector:"calendar-sheet-drop-target",template:"",providers:[services_2.model],host:{"(dragover)":"this.dragOver($event)","(dragenter)":"this.dragEnter($event)","(dragleave)":"this.dragLeave($event)","(drop)":"this.drop($event)","[class]":"this.getClass()"}}),__metadata("design:paramtypes",[calendar,services_2.model])],e)}();exports.CalendarSheetDropTarget=CalendarSheetDropTarget;var CalendarMorePopover=function(){function e(e,t,s,n){this.metadata=e,this.calendar=t,this.router=s,this.language=n,this.events=[],this.popoverside="right",this.popoverpos="top",this.styles=null,this.hidePopoverTimeout={},this.parentElementRef=null,this.self=null,this.heightcorrection=30,this.widthcorrection=30}return e.prototype.ngOnInit=function(){this.styles=this.popoverStyle},e.prototype.goDetails=function(e,t){this.closePopover(!0),this.router.navigate(["/module/"+t+"/"+e])},e.prototype.onMouseOver=function(){this.hidePopoverTimeout&&window.clearTimeout(this.hidePopoverTimeout)},e.prototype.onMouseOut=function(){this.closePopover(!0)},Object.defineProperty(e.prototype,"popoverStyle",{get:function(){var e=this.parentElementRef.nativeElement.getBoundingClientRect(),t=this.popover.element.nativeElement.getBoundingClientRect();return e.left<t.width?this.popoverside="right":this.popoverside="left",e.top-30+t.height>window.innerHeight&&0<e.top-t.height+this.heightcorrection?(this.popoverpos="bottom",{top:e.top-t.height+this.heightcorrection+"px",left:e.left<t.width?e.left+100+"px":e.left-t.width-this.widthcorrection+"px"}):(this.popoverpos="top",{top:e.top-this.heightcorrection+"px",left:e.left<t.width?e.left+100+"px":e.left-t.width-this.widthcorrection+"px"})},enumerable:!0,configurable:!0}),e.prototype.getNubbinClass=function(){return("left"==this.popoverside?"slds-nubbin--right-":"slds-nubbin--left-")+this.popoverpos},e.prototype.closePopover=function(e){var t=this;void 0===e&&(e=!1),e?this.self.destroy():this.hidePopoverTimeout=window.setTimeout(function(){return t.self.destroy()},500)},__decorate([core_1.ViewChild("popover",{read:core_1.ViewContainerRef}),__metadata("design:type",core_1.ViewContainerRef)],e.prototype,"popover",void 0),e=__decorate([core_1.Component({template:'<div class="slds-popover slds-popover--panel slds-is-fixed" [ngStyle]="popoverStyle" [ngClass]="getNubbinClass()" role="dialog" (mouseenter)="onMouseOver()" (mouseleave)="onMouseOut()"><button class="slds-button slds-button_icon slds-button_icon slds-button_icon-small slds-float_right slds-popover__close" (click)="closePopover(true)"><system-button-icon icon="close"></system-button-icon></button><div #popover><div class="slds-popover__header" style="padding: .5rem"><header class="slds-text-heading--small slds-m-bottom--x-small">{{events.length}} {{language.getLabel(\'LBL_EVENTS\')}}</header><div class="slds-scrollable--y" style="height: 120px"><calendar-more-popover-event *ngFor="let event of events" [event]="event" (action$)="closePopover(true)"></calendar-more-popover-event></div></div></div></div>',providers:[calendar]}),__metadata("design:paramtypes",[services_1.metadata,calendar,router_1.Router,services_4.language])],e)}();exports.CalendarMorePopover=CalendarMorePopover;var CalendarMorePopoverEvent=function(){function e(e,t,s){var n=this;this.model=e,this.session=t,this.userpreferences=s,this.event={},this.action$=new core_1.EventEmitter,this.model.mode$.subscribe(function(e){return n.action$.emit(e)})}return e.prototype.ngOnInit=function(){this.model.module=this.event.module,this.model.id=this.event.id,this.model.data=this.event.data},e.prototype.canEdit=function(e){return this.session.authData.userId==e},e.prototype.getStartHour=function(e){return e.data.date_start?moment(e.data.date_start).tz(moment.tz.guess()).add(moment().utcOffset(),"m").format(this.userpreferences.getTimeFormat()):"00:00"},__decorate([core_1.ViewChild("calendarcontent",{read:core_1.ViewContainerRef}),__metadata("design:type",core_1.ViewContainerRef)],e.prototype,"calendarcontent",void 0),__decorate([core_1.Input(),__metadata("design:type",Object)],e.prototype,"event",void 0),__decorate([core_1.Output(),__metadata("design:type",core_1.EventEmitter)],e.prototype,"action$",void 0),e=__decorate([core_1.Component({selector:"calendar-more-popover-event",template:'<div class="slds-m-around--xxx-small slds-p-horizontal--xx-small" style="height: 20px; border-radius: 2px;" [style.background-color]="event.color ? event.color : \'rgb(3, 155, 229)\'"><div class="slds-grid slds-grid--align-spread"><div class="slds-truncate" style="height: 100%;" (click)="goDetails(event.id, event.module)"><span [title]="event.data.summary_text" class="slds-text-link--reset slds-text-color--inverse">{{event.data.summary_text}}</span> <span class="slds-text-color--inverse" *ngIf="isMulti">, {{getStartHour(event)}}</span></div><object-action-menu *ngIf="canEdit(event.data.assigned_user_id)" class="slds-m-top--xxx-small" [buttonsize]="\'xx-small\'"></object-action-menu></div></div>',providers:[services_10.view,services_2.model]}),__metadata("design:paramtypes",[services_2.model,services_8.session,userpreferences])],e)}();exports.CalendarMorePopoverEvent=CalendarMorePopoverEvent;var CalendarMoreButton=function(){function e(e,t,s,n){this.elementRef=e,this.language=t,this.footer=s,this.metadata=n,this.events=[],this.popoverCmp=null,this.showPopoverTimeout={}}return e.prototype.onMouseOver=function(){var e=this;this.showPopoverTimeout=window.setTimeout(function(){return e.renderPopover()},500)},e.prototype.onMouseOut=function(){this.showPopoverTimeout&&window.clearTimeout(this.showPopoverTimeout),this.popoverCmp&&this.popoverCmp.closePopover()},e.prototype.renderPopover=function(){var t=this;this.metadata.addComponent("CalendarMorePopover",this.footer.modalcontainer).subscribe(function(e){e.instance.events=t.events,e.instance.parentElementRef=t.elementRef,t.popoverCmp=e.instance})},e.prototype.ngOnDestroy=function(){this.popoverCmp&&this.popoverCmp.closePopover(!0)},__decorate([core_1.Input("moreevents"),__metadata("design:type",Array)],e.prototype,"events",void 0),__decorate([core_1.HostListener("mouseenter"),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],e.prototype,"onMouseOver",null),__decorate([core_1.HostListener("mouseleave"),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],e.prototype,"onMouseOut",null),e=__decorate([core_1.Component({selector:"calendar-more-button",template:"<span style=\"cursor: pointer\">{{language.getLabel('LBL_MORE')}}</span>"}),__metadata("design:paramtypes",[core_1.ElementRef,services_4.language,services_9.footer,services_1.metadata])],e)}();exports.CalendarMoreButton=CalendarMoreButton;var ModuleCalendar=function(){function ModuleCalendar(e){this.vms=e,this.version="1.0",this.build_date="2018-11-23",this.vms.registerModule(this)}return ModuleCalendar=__decorate([core_1.NgModule({imports:[common_1.CommonModule,forms_1.FormsModule,objectfields_1.ObjectFields,globalcomponents_1.GlobalComponents,objectcomponents_1.ObjectComponents,systemcomponents_1.SystemComponents,directives_1.DirectivesModule],declarations:[Calendar,CalendarDatePicker,CalendarSheetDay,CalendarSheetWeek,CalendarSheetMonth,CalendarSheetEvent,CalendarEventSummary,CalendarSheetDropTarget,CalendarMorePopover,CalendarMorePopoverEvent,CalendarMoreButton],providers:[userpreferences]}),__metadata("design:paramtypes",[services_14.VersionManagerService])],ModuleCalendar)}();exports.ModuleCalendar=ModuleCalendar;